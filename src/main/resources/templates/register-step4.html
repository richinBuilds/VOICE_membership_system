<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Review your cart - VOICE Membership">

    <title>Review Cart - VOICE Membership System</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>

<body class="register-page">

<div class="checkout-container" data-testid="register-step4-container">

    <div class="checkout-card">

        <!-- Header -->
        <div class="checkout-header">

            <h1 class="checkout-title" data-testid="step4-title">
                <i class="fas fa-shopping-cart me-2"></i>
                Review Your Order
            </h1>

            <p class="text-muted">
                Step <span th:text="${step}">4</span>
                of <span th:text="${totalSteps}">4</span>
                â€” Final Review
            </p>

            <!-- Step Indicator -->
            <div class="step-indicator" data-testid="step-indicator">
                <div class="step active">1</div>
                <div class="step active">2</div>
                <div class="step active">3</div>
                <div class="step active">4</div>
            </div>

        </div>

        <!-- Error Alert -->
        <div th:if="${error}"
             class="alert alert-danger mb-3"
             role="alert"
             data-testid="cart-error">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}">Error message</span>
        </div>

        <!-- Form -->
        <form th:action="@{/register/step4}"
              method="post"
              id="cartForm"
              data-testid="cart-form">

            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <!-- Cart Item -->
            <div class="cart-item" th:if="${membership}" data-testid="cart-item">

                <div class="cart-item-header">
                    <div class="cart-item-title" th:text="${membership.name}" data-testid="cart-membership-name">
                        Membership Name
                    </div>

                    <button type="button"
                            onclick="removeFromCart()"
                            class="btn-danger-custom"
                            data-testid="remove-item-btn">
                        <i class="fas fa-trash me-1"></i> Remove
                    </button>
                </div>

                <div class="cart-item-details">

                    <p th:if="${membership.description}">
                        <strong>Description:</strong>
                        <span th:text="${membership.description}">Description text</span>
                    </p>

                    <div th:if="${membership.features}">
                        <strong>Included Features:</strong>
                        <ul class="ms-3 mt-2">
                            <li th:each="feature : ${#strings.arraySplit(membership.features, lineSeparator)}"
                                th:text="${feature.trim()}">
                                Feature item
                            </li>
                        </ul>
                    </div>

                </div>

            </div>

            <!-- Order Summary -->
            <div class="cart-summary" data-testid="order-summary">

                <div class="cart-summary-row">
                    <span>Membership Plan</span>
                    <span th:text="${membership.name}">Plan Name</span>
                </div>

                <div class="cart-summary-row">
                    <span>Price</span>
                    <span th:if="${membership.isFree}">Free</span>
                    <span th:unless="${membership.isFree}">
                        $<span th:text="${membership.price}">0</span>
                    </span>
                </div>

                <div class="cart-summary-total">
                    <span>Total</span>
                    <span th:if="${membership.isFree}" data-testid="cart-total">Free</span>
                    <span th:unless="${membership.isFree}" data-testid="cart-total">
                        $<span th:text="${membership.price}">0</span>
                    </span>
                </div>

            </div>

            <!-- Navigation Buttons -->
            <div class="btn-group-custom">

                <a th:href="@{/register/step3}"
                   class="btn btn-secondary-custom"
                   data-testid="step4-back-btn">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </a>

                <button type="submit"
                        id="submitBtn"
                        class="btn btn-primary-custom"
                        data-testid="step4-submit-btn">

                    <span th:if="${membership.isFree}">
                        <i class="fas fa-check me-1"></i>
                        Complete Registration
                    </span>

                    <span th:unless="${membership.isFree}">
                        Proceed to Payment
                        <i class="fas fa-arrow-right ms-1"></i>
                    </span>

                </button>

            </div>

        </form>

    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
// Remove item from cart
function removeFromCart() {
    if (!confirm('Are you sure you want to remove this item from your cart?')) {
        return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/register/step4';

    const csrfToken = document.querySelector('input[name="_csrf"]').value;

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = csrfToken;

    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'remove';

    form.appendChild(csrfInput);
    form.appendChild(actionInput);
    document.body.appendChild(form);
    form.submit();
}

// Prevent double form submission
const form = document.getElementById('cartForm');
const submitBtn = document.getElementById('submitBtn');

if (form && submitBtn) {
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    });
}
</script>

</body>
</html>
