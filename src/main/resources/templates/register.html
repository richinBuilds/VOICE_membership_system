<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create your VOICE account - Step 1">

    <title>Create Account - VOICE Membership System</title>

    <!-- Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Global CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    
    <style>
        body {
            background: #09637E;
            min-height: 100vh;
        }
        .address-autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 2px;
        }
        .address-autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .address-autocomplete-item:hover {
            background-color: #f5f5f5;
        }
        .address-autocomplete-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>

<div class="checkout-container" data-testid="register-step1-container">

    <div class="auth-card">

        <!-- Header -->
        <div class="auth-header">

            <h1 data-testid="step1-title">
                <i class="fas fa-user-plus me-2"></i>
                Create Your Account
            </h1>

            <p class="text-muted">
                Step <span th:text="${step}">1</span>
                of <span th:text="${totalSteps}">4</span>
                â€” Your Details
            </p>

            <!-- Step Indicator -->
            <div class="step-indicator" data-testid="step-indicator">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
                <div class="step">4</div>
            </div>

        </div>

        <!-- Error Alert -->
        <div th:if="${param.error}" class="alert alert-danger mb-3" role="alert" data-testid="registration-error">
            <i class="fas fa-exclamation-circle me-2"></i>
            Registration failed. Please try again.
        </div>

        <!-- Form -->
        <form th:action="@{/register/step1}"
              method="post"
              id="registerForm"
              th:object="${registerDto}"
              data-testid="register-form">

            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <!-- First Name -->
            <div class="form-floating">
                <input type="text"
                       class="form-control"
                       th:class="${#fields.hasErrors('firstName')} ? 'form-control is-invalid' : 'form-control'"
                       id="firstName"
                       th:field="*{firstName}"
                       placeholder="First Name"
                       required
                       data-testid="register-firstName">
                <label for="firstName">
                    <i class="fas fa-user me-1"></i> First Name *
                </label>
                <div th:if="${#fields.hasErrors('firstName')}" class="invalid-feedback" th:errors="*{firstName}">
                    First name is required
                </div>
            </div>

            <!-- Middle Name -->
            <div class="form-floating">
                <input type="text"
                       class="form-control"
                       id="middleName"
                       th:field="*{middleName}"
                       placeholder="Middle Name"
                       data-testid="register-middleName">
                <label for="middleName">
                    <i class="fas fa-user me-1"></i> Middle Name (Optional)
                </label>
            </div>

            <!-- Last Name -->
            <div class="form-floating">
                <input type="text"
                       class="form-control"
                       th:class="${#fields.hasErrors('lastName')} ? 'form-control is-invalid' : 'form-control'"
                       id="lastName"
                       th:field="*{lastName}"
                       placeholder="Last Name"
                       required
                       data-testid="register-lastName">
                <label for="lastName">
                    <i class="fas fa-user me-1"></i> Last Name *
                </label>
                <div th:if="${#fields.hasErrors('lastName')}" class="invalid-feedback" th:errors="*{lastName}">
                    Last name is required
                </div>
            </div>

            <!-- Email -->
            <div class="form-floating">
                <input type="email"
                       class="form-control"
                       th:class="${#fields.hasErrors('email')} ? 'form-control is-invalid' : 'form-control'"
                       id="email"
                       th:field="*{email}"
                       placeholder="Email Address"
                       required
                       data-testid="register-email">
                <label for="email">
                    <i class="fas fa-envelope me-1"></i> Email Address *
                </label>
                <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback" th:errors="*{email}">
                    Valid email is required
                </div>
            </div>

            <!-- Password Row -->
            <div class="form-row">

                <!-- Password -->
                <div class="form-floating">
                    <input type="password"
                           class="form-control"
                           th:class="${#fields.hasErrors('password')} ? 'form-control is-invalid' : 'form-control'"
                           id="password"
                           th:field="*{password}"
                           placeholder="Password"
                           required
                           minlength="8"
                           data-testid="register-password">
                    <label for="password">
                        <i class="fas fa-lock me-1"></i> Password *
                    </label>
                    <div th:if="${#fields.hasErrors('password')}" class="invalid-feedback" th:errors="*{password}">
                        Password must be at least 8 characters
                    </div>
                </div>

                <!-- Confirm Password -->
                <div class="form-floating">
                    <input type="password"
                           class="form-control"
                           th:class="${#fields.hasErrors('confirmPassword')} ? 'form-control is-invalid' : 'form-control'"
                           id="confirmPassword"
                           th:field="*{confirmPassword}"
                           placeholder="Confirm Password"
                           required
                           data-testid="register-confirm-password">
                    <label for="confirmPassword">
                        <i class="fas fa-lock me-1"></i> Confirm Password *
                    </label>
                    <div th:if="${#fields.hasErrors('confirmPassword')}" class="invalid-feedback" th:errors="*{confirmPassword}">
                        Passwords must match
                    </div>
                </div>

            </div>

            <!-- Phone -->
            <div class="form-floating">
                <input type="tel"
                       class="form-control"
                       th:class="${#fields.hasErrors('phone')} ? 'form-control is-invalid' : 'form-control'"
                       id="phone"
                       th:field="*{phone}"
                       placeholder="(123) 456-7890"
                       pattern="^\\(?([0-9]{3})\\)?[-.\\s]?([0-9]{3})[-.\\s]?([0-9]{4})$"
                       title="Canadian phone number: (XXX) XXX-XXXX or XXX-XXX-XXXX or 10 digits"
                       maxlength="15"
                       inputmode="tel"
                       required
                       data-testid="register-phone">
                <label for="phone">
                    <i class="fas fa-phone me-1"></i> Phone Number *
                </label>
                <div th:if="${#fields.hasErrors('phone')}" class="invalid-feedback" th:errors="*{phone}">
                    Invalid Canadian phone number format
                </div>
            </div>

            <!-- Address -->
            <div class="form-floating" style="position: relative;">
                <input type="text"
                       class="form-control"
                       id="address"
                       th:field="*{address}"
                       placeholder="Address"
                       autocomplete="off"
                       data-testid="register-address">
                <label for="address">
                    <i class="fas fa-home me-1"></i> Address (Optional)
                </label>
                <div id="address-dropdown" class="address-autocomplete-dropdown" style="display: none;"></div>
            </div>

            <!-- Postal Code -->
            <div class="form-floating">
                <input type="text"
                       class="form-control"
                       th:class="${#fields.hasErrors('postalCode')} ? 'form-control is-invalid' : 'form-control'"
                       id="postalCode"
                       th:field="*{postalCode}"
                       placeholder="Postal Code"
                       pattern="[A-Za-z][0-9][A-Za-z][ ]?[0-9][A-Za-z][0-9]"
                       data-testid="register-postal-code">
                <label for="postalCode">
                    <i class="fas fa-map-marker-alt me-1"></i> Postal Code (Optional)
                </label>
                <div th:if="${#fields.hasErrors('postalCode')}" class="invalid-feedback" th:errors="*{postalCode}">
                    Valid Canadian postal code required
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="btn-group-custom">

                <a th:href="@{/}"
                   class="btn btn-secondary-custom"
                   data-testid="step1-back-btn">
                    <i class="fas fa-arrow-left me-1"></i> Back to Home
                </a>

                <button type="submit"
                        class="btn btn-primary-custom"
                        data-testid="step1-next-btn">
                    Continue
                    <i class="fas fa-arrow-right ms-1"></i>
                </button>

            </div>

        </form>

        <!-- Sign In Link -->
        <div class="signup-link">
            <p class="mb-0">
                Already have an account?
                <a th:href="@{/login}" class="auth-link" data-testid="signin-link">Sign In</a>
            </p>
        </div>

    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
// Form validation
document.getElementById('registerForm').addEventListener('submit', function(e) {
    const phone = document.getElementById('phone').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Validate phone number - Canadian format
    const phoneRegex = /^(\()?([0-9]{3})(\))?([-.\s])?([0-9]{3})([-.\s])?([0-9]{4})$/;
    if (!phoneRegex.test(phone)) {
        e.preventDefault();
        document.getElementById('phone').classList.add('is-invalid');
        alert('Invalid Canadian phone number format. Use: (XXX) XXX-XXXX or XXX-XXX-XXXX or 10 digits');
        return false;
    }
    
    // Verify phone contains exactly 10 digits
    const phoneDigits = phone.replace(/\D/g, '');
    if (phoneDigits.length !== 10) {
        e.preventDefault();
        document.getElementById('phone').classList.add('is-invalid');
        alert('Phone number must contain exactly 10 digits');
        return false;
    }
    
    if (password !== confirmPassword) {
        e.preventDefault();
        document.getElementById('confirmPassword').classList.add('is-invalid');
        alert('Passwords do not match. Please try again.');
        return false;
    }
    
    // Basic password strength check
    if (password.length < 8) {
        e.preventDefault();
        document.getElementById('password').classList.add('is-invalid');
        alert('Password must be at least 8 characters long.');
        return false;
    }
});

// Real-time phone validation
document.getElementById('phone').addEventListener('blur', function() {
    const phone = this.value;
    const phoneRegex = /^(\()?([0-9]{3})(\))?([-.\s])?([0-9]{3})([-.\s])?([0-9]{4})$/;
    
    if (phone && !phoneRegex.test(phone)) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// Phone number auto-formatting
document.getElementById('phone').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    
    if (value.length > 10) {
        value = value.slice(0, 10);
    }
    
    if (value.length >= 6) {
        this.value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6);
    } else if (value.length >= 3) {
        this.value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
    } else if (value.length > 0) {
        this.value = value;
    }
});

// Real-time password match check
document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && password !== confirmPassword) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// Postal Code auto-formatting (Canadian format: A1A 1A1)
document.getElementById('postalCode').addEventListener('input', function() {
    let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    
    if (value.length > 6) {
        value = value.slice(0, 6);
    }
    
    if (value.length >= 4) {
        this.value = value.slice(0, 3) + ' ' + value.slice(3);
    } else {
        this.value = value;
    }
});

// OpenStreetMap Nominatim Address Autocomplete (Free)
const addressInput = document.getElementById('address');
const dropdown = document.getElementById('address-dropdown');
let debounceTimer;

if (addressInput) {
    addressInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(debounceTimer);
        
        if (query.length < 3) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Debounce API calls
        debounceTimer = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ca&addressdetails=1&limit=5`, {
                headers: {
                    'User-Agent': 'VOICE-Membership-System'
                }
            })
            .then(response => response.json())
            .then(data => {
                dropdown.innerHTML = '';
                
                if (data.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                data.forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'address-autocomplete-item';
                    
                    // Format address without postal code
                    let addressParts = [];
                    if (place.address) {
                        const addr = place.address;
                        if (addr.house_number) addressParts.push(addr.house_number);
                        if (addr.road) addressParts.push(addr.road);
                        if (addr.city || addr.town || addr.village) {
                            addressParts.push(addr.city || addr.town || addr.village);
                        }
                        if (addr.state) addressParts.push(addr.state);
                    }
                    
                    const displayAddress = addressParts.length > 0 ? addressParts.join(', ') : place.display_name.split(',').slice(0, 3).join(',');
                    item.textContent = displayAddress;
                    
                    item.addEventListener('click', function() {
                        addressInput.value = displayAddress;
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(item);
                });
                
                dropdown.style.display = 'block';
            })
            .catch(error => {
                console.error('Address lookup error:', error);
                dropdown.style.display = 'none';
            });
        }, 300);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!addressInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
}
</script>

</body>
</html>
